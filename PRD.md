# 개인용 주식 자동 매매 시스템 PRD (v1)

- **문서 상태**: v1 업데이트
- **작성일**: 2025-09-21
- **사용자**: 손 (개인)
- **목표**: 내 보유 주식/관심 주식에 대해 자동으로 사고팔기, 퀀트 로직 기반, 한국투자증권 API 연결, 인터페이스 교체 가능한 구조 설계

---

## 0. 비전
개인 투자자가 반복적이고 감정적인 매매를 줄이고, **데이터 기반 의사결정**을 자동화한다. 한국투자증권 API를 시작점으로, 추후 다른 브로커 API로 확장할 수 있는 **모듈형 구조**를 설계한다.

---

## 1. 범위 (Scope)
**In-Scope**
- 한국투자증권 OpenAPI 기반 자동 매매 (주문/체결/잔고/시세)
- 퀀트 전략 적용 (이동평균선, 거래량 필터 등)
- 데이터 수집(시세/체결) 및 로컬 저장·관리
- 주문 상태 추적 및 체결 확인
- 기본 리스크 제어 (손실 한도, 보유 종목 수 제한)
- 인터페이스 추상화 (브로커 교체 가능)
- 단순 UI (CLI or 최소 대시보드)

**Out-of-Scope (v1)**
- 파생상품/선물/옵션
- 초고빈도(HFT)
- 멀티 유저/기업형 확장

---

## 2. 핵심 목표
- **자동화**: 특정 조건 충족 시 주문 자동 실행
- **데이터 관리**: 시세/체결 데이터 수집 및 로컬 저장
- **리스크 관리**: 손실 제한, 보유 종목 제한
- **모듈성**: API 인터페이스 추상화로 교체 용이
- **관측성**: 로그와 지표로 투명한 추적

---

## 3. 주요 기능
### 3.1 브로커 API 추상화 계층
- **BrokerAdapter 인터페이스 정의**
  - `get_price(symbol)`
  - `send_order(symbol, side, qty, price, order_type)`
  - `get_balance()`
  - `get_positions()`
- **구현체 1**: 한국투자증권 OpenAPI Adapter
- 추후 다른 브로커 Adapter 추가 가능

### 3.2 데이터 수집
- 한국투자증권 API 통한 실시간 시세 수집
- 관심 종목 리스트 관리
- 로컬 DB(SQLite/MariaDB)에 저장
- 과거 데이터와 실시간 데이터 동일 전처리

### 3.3 전략 실행
- 입력: 가격/거래량 데이터
- 출력: 매수/매도 신호
- 예시 전략:
  - 이동평균선 50일/200일 교차 + 거래량 필터
  - 손절 -5%, 목표 수익 +10%
- 전략 모듈 외부 파라미터로 설정 가능 (JSON/YAML)

### 3.4 주문 관리
- 주문 생성: client_order_id 포함 (idempotent)
- 상태 추적: 체결 여부 실시간 확인
- 실패 시 재시도/취소/알림 처리

### 3.5 리스크 제어
- 일중 손실 한도: -2% 이상 시 거래 중지
- 종목당 최대 보유 수량 제한
- 포트폴리오 내 종목 비중 제한 (예: 20%)
- 쿨다운: 동일 종목 연속 주문 실패 시 일정 시간 대기

### 3.6 로그/리포트/관측성
- 구조화 로그(JSON) + human-readable 로그 동시 기록
- 거래 사유(reason) 필드 포함
- 일간 리포트 생성 (수익률, 손실, 거래 횟수)
- 모니터링 지표: 주문 실패율, 주문 지연, 현재 드로우다운
- 알림 채널: Slack/Email

---

## 4. 비기능 요구사항 (NFR)
- 단일 사용자, 단일 서버(홈서버) 운영 가능
- 주문 지연(latency): 수백 ms 수준 허용
- 오류 발생 시 Kill Switch로 즉시 중단 가능
- 실거래와 모의거래 계정 모두 지원
- 인증 키 보안 관리 (환경변수/외부 Secrets)

---

## 5. 한국투자증권 API 고려 사항
- 인증: API Key/Secret + Access Token (만료/갱신 처리 필요)
- 호출 제한: 주문/시세 API rate limit 명시 필요
- 시간대: 국내 장내/장외/시간외 거래 지원 범위 확인
- 응답 코드 처리: 오류 코드별 대응 전략 정의 (재시도, 중지 등)
- 모의투자와 실거래 API 구분

---

## 6. 운영 및 배포
- Docker 기반 환경 구성 (개발/테스트/실거래 분리)
- Config 파일로 전략/파라미터 관리
- GitOps 스타일 버전 관리
- CI/CD: 코드 푸시 시 자동 테스트 + 배포 가능성 고려

---

## 7. 테스트 전략
- 단위: 전략 로직, 리스크 룰
- 통합: 주문 API 목(mock) 구현 후 시나리오 테스트
- 리플레이: 과거 장 데이터를 사용한 전략 검증
- 페이퍼 트레이딩 모드 → 실거래 전환 단계적 진행

---

## 8. 보안 및 인증
- API Key/Secret 암호화 저장
- TLS 통신 강제
- 접근 제어 및 감사 로그 기록
- 환경 변수/외부 secrets manager 사용

---

## 9. 추가 고려 사항
- 슬리피지/수수료/세금 포함한 손익 계산
- 주문 실패/네트워크 장애 시 복구 로직
- UI는 최소 CLI, 추후 웹 대시보드 확장 고려
- 전략 변경/배포 승인 이력 관리 (간단 버전)

---

## 10. 단계적 로드맵
- **v0**: 데이터 수집 + 신호 출력
- **v1**: 한국투자증권 API 주문 연동 + 체결 확인
- **v1.1**: 리스크 제어, 리포트, 알림 추가
- **v2**: 전략 플러그인 구조 + UI 대시보드 확장
- **v3**: 다중 브로커 Adapter 지원 + 고급 전략

---

## 11. 기술 스택 & 런타임 (Python 최신, 안전 운영)
- **언어/런타임**: Python 3.12+ (가급적 LTS 이미지 기반)
- **패키지 관리**: uv/poetry 중 택1 (잠금파일 필수), 사내/개인 PyPI 미러 옵션
- **타입/품질**: mypy/pyright, ruff/flake8, black, bandit(보안 정적분석)
- **프로세스 모델**: 단일 서비스 시작 → 전략/브로커/리스크 모듈 플러그인 로딩
- **동시성**: asyncio 기반 이벤트 루프 + I/O 바인딩 (브로커/웹소켓/DB)
- **컨테이너**: Docker(슬림 베이스) + distroless 런타임 이미지 권장
- **구성 관리**: pydantic‑settings(YAML/ENV), 런타임 재로딩(신중히)

---

## 12. 데이터 저장소 (PostgreSQL)
- **접속**: 내부 IP 직접 호출, 연결 풀 관리(예: asyncpg/psycopg 3)
- **스키마(핵심 테이블 개념)**
  - `symbols`: 종목 메타(심볼, 시장, 상태)
  - `market_bars`: 시세(시간, 심볼, O/H/L/C, 거래량, 소스)
  - `signals`: 전략ID, 심볼, 방향, 강도, 파라미터 해시, 근거(reason)
  - `orders`: client_order_id, 심볼, 수량, 가격, 상태, 오류코드, 타임라인
  - `executions`: 체결 ID, 체결가, 수량, 수수료/세금, 누적 체결
  - `positions`: 현재 보유 수량/평단, 실현/미실현 손익
  - `risk_events`: 룰ID, 입력 스냅샷, 판정, 메시지
  - `configs`: 전략/리스크/브로커 설정 버전 관리(감사 가능)
- **성능/유지보수**: 파티셔닝(날짜/심볼), 인덱스 설계(ts, symbol), 아카이브/TTL
- **트랜잭션**: 주문/체결/포지션 업데이트는 동일 트랜잭션 또는 이벤트 소싱으로 최종 일관 확보

---

## 13. 스트리밍 (Kafka – IP 직접 호출)
- **브로커 접속**: 내부 IP, SASL/TLS 옵션(가능 시)
- **토픽 설계(초안)**
  - `market.bar` (분봉/틱 정규화)
  - `signal.out` (전략 출력: 진입/청산/목표수량)
  - `order.new` / `order.state` (주문 생성/상태 변동 이벤트)
  - `execution.fill` (체결 피드)
  - `risk.event` (리스크 판정 로그)
- **키/파티션**: `symbol` 키 파티셔닝(순서 보장), 정확한 순서가 중요하면 동일 파티션 유지
- **전달 보장**: at‑least‑once + idempotent producer, 중복은 client_order_id로 멱등 처리
- **스키마**: Avro/Protobuf 중 택1(스키마 레지스트리 권장, 없으면 버전 필드 포함)
- **DLQ**: 역직렬화 실패/유효성 실패 → `*.dlq` 토픽으로 격리

---

## 14. 플러그인 아키텍처 (전략/브로커/리스크)
- **플러그인 타입**
  - `BrokerAdapter` (한국투자증권 구현체 기본, 교체 가능)
  - `Strategy` (신호 생성 모듈; 파라미터 외부화)
  - `RiskRule` (사전/사후 체크 룰 집합)
- **발견/로딩**: 진입점(entry points) 또는 명시적 모듈 경로 로딩, 서명/해시 확인
- **격리/안전**: 모듈 화이트리스트, 제한된 권한(파일/네트워크), 시간 제한(타임아웃)
- **계약(Contract)**: 공용 DTO(예: Pydantic 모델)로 모듈 간 자료교환
- **버전 호환**: 인터페이스 버전 필드, 구버전 플러그인 차단/마이그레이션 정책

---

## 15. 운영 안전장치 (Operational Safety)
- **Kill Switch**: 전역/전략 단위 즉시 중단, 신규 주문 차단 + 미체결 취소 옵션
- **레이스/중복 방지**: `client_order_id` 멱등키, 중복 이벤트 필터
- **레이트 제한/쿨다운**: 브로커 API 한도 초과 방지, 지수 백오프 재시도
- **가격 콜라/체결 보호**: 기준가 대비 ±X% 외 가격 주문 차단, 급격 변동 시 자동 보류
- **장애 복구**: 재시작 시 오프셋/포지션/미체결 동기화 시퀀스 정의
- **승인 플로우**: 실거래 전환/리스크 파라미터 변경 시 2단계 확인(개인용은 자기확인 로그)

---

## 16. 네트워크/IP 구성
- **고정 IP/보안그룹**: DB/Kafka/브로커 API 출구 제어(아웃바운드 최소화)
- **TLS**: 가능한 모든 구간 TLS(브로커/DB), 인증서 갱신 자동화
- **시간 동기화**: NTP + 모든 로그 UTC 타임스탬프 저장

---

## 17. 비밀/자격증명 관리
- **저장 금지**: 레포에 키 저장 금지, `.env` 암호화/외부 시크릿 관리자
- **회전**: 키/토큰 주기적 회전 정책, 만료/리프레시 자동화(한국투자증권 토큰 포함)
- **권한 최소화**: 읽기/주문 권한 분리 가능성 검토(모의/실전 구분)

---

## 18. 릴리즈/배포 정책
- **채널**: dev → paper → live (소액)
- **검증**: 각 채널에서 동일 테스트 스위트, 리플레이 시나리오 통과 필수
- **롤백**: 전 버전 컨테이너/설정 스냅샷 유지, 원클릭 롤백

---

## 19. 관측성
- **로그**: 구조화(JSON) + 상관키(correlation_id), 주문 타임라인 로그
- **메트릭**: 주문 지연, 실패율, 슬리피지 추정, 현재/최대 드로우다운, 체결 비율
- **트레이싱**: 주문ID 단위 분산 트레이스(신호→리스크→주문→체결)
- **알림**: 심각도별 Slack/Email, 임계치 기반 룰

---

## 20. 장애/예외 시나리오 (예)
1) **브로커 API 타임아웃** → 재시도(백오프) → 실패 누적 시 전략 일시 중지 + 알림
2) **Kafka 장애** → 프로듀서 버퍼링/로컬 큐 → 임계 초과 시 안전 중지
3) **DB 연결 풀 고갈** → 순간 거래량 제한(쓰로틀링) + 경고
4) **데이터 결측/지연** → 신호 중단, 최근가 신뢰 임계 도달 시 주문 금지

---

## 21. 실행 체크리스트(개인용)
- [ ] Postgres/Kafka 내부 IP, 방화벽/보안그룹 설정 완료
- [ ] 한국투자증권 API 키 발급 + 모의 계정 테스트 통과
- [ ] 전략 플러그인 1개(이평+거래량) 파라미터 확정
- [ ] 레이트 제한/쿨다운/가격 콜라 기준값 설정
- [ ] Kill Switch 동작 리허설(페이퍼/실전 분리)
- [ ] 백테스트 ↔ 페이퍼 결과 차이 리포트 생성
